Select
A.case_id,
CAST(A.case_start_day as DATE) as case_start_day,
CAST(A.case_start_week as DATE) as case_start_week,
CAST(FORMAT_DATE('%F',DATE_TRUNC(CAST(A.case_start_day AS DATE), MONTH)) as DATE) as case_start_month,
A.case_start_quarter,
A.survey_response_day,
A.locale,
A.opening_channel,
A.task_owner,
A.quality_reviewer,
CASE 
  WHEN A.grade='support / love driven' THEN 'support' 
  WHEN A.grade='product / policy driven' THEN 'product' 
  ELSE NULL END as Main_Driver,
CASE 
  WHEN A.category='support / love' THEN 'support' 
  WHEN A.category='product / policy' THEN 'product' 
  ELSE NULL END as Level1,
A.question as Level2,
A.selected_option as Level3,
B.qa_comments


From (
    SELECT *,
    is_aligned as is_aligned_v2
    FROM youtube_creator_support_dremel.qplus
    WHERE review_type ='RCA Review'
    AND queue_site='SEO'
    AND selected_option not in ('no','no error','yes','support / love','product / policy')
    AND stage in ('RCA (TVC review)')
    AND queue in ('[SEO] RCA Core (new)')) A
  
Left JOIN (
  Select
case_id,
String_Agg(question_comment, ' |*__*| ') as qa_comments

From (
    SELECT *,
    is_aligned as is_aligned_v2
    FROM youtube_creator_support_dremel.qplus
    WHERE review_type ='RCA Review'
    AND queue_site='SEO'
    AND stage in ('RCA (TVC review)')
    AND queue in ('[SEO] RCA Core (new)'))
group by 1) B
on A.case_id=B.case_id

WHERE case_start_quarter in ('2021-Q1','2021-Q2','2021-Q3','2021-Q4','2022-Q1','2022-Q2','2022-Q3','2022-Q4')
Order by 2 desc, 1 desc, 11 asc


