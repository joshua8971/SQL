Select 
  A.case_id,
  CAST(A.date as date) as date, 
  CAST(A.week as date) as week,
  CAST(FORMAT_DATE('%F',DATE_TRUNC(CAST (A.date as DATE), MONTH)) as DATE) as month,
  A.quarter,
  A.language,
  A.channel,
  A.ldap,
  A.partner_tier,
  CAST(A.satisfaction as int64) as satisfaction,
  A.neo_feature,
  A.neo_component,
  A.neo_component_detail,
  A.neo_request,
  A.ytdp_issue_resolved,
  A.ytdp_dissatisfied,  
  A.ytdp_dissatisfied_else,  
  A.ytdp_neither,
  B.partner_comments,
  B.Ytdp_satisfied,
  null as dsat_other_comments,
  A.closed_day,
  NULL as ldap1,  
  NULL as survey_resposne_day,
  A.neo_product,
  A.neo_policy_type,
  A.neo_business_policy,
  A.neo_policy_enforcement,
  A.neo_workdriver,
  A.neo_resolution_detail  

  
  
FROM  

(select 
  case_id, 
  time.start_day as date,
  time.start_week as week,
  time.start_month as month,
  time.start_quarter as quarter,
  CASE WHEN (d_neo.locale = "Korean" or d_neo.locale = "Korean (South Korea)") THEN "Korean" 
  WHEN (d_neo.locale = "Japanese" or d_neo.locale = "Japanese (Japan)") THEN "Japanese" ELSE NULL END as language,
  attributes.opening_channel as channel,  
  assignee.ldap as ldap,
  d_neo.product_name as neo_product,
  d_neo.feature as neo_feature,
  d_neo.component as neo_component,
  d_neo.component_detail as neo_component_detail,
  d_neo.policy_type as neo_policy_type,
  d_neo.policy_enforcement as neo_policy_enforcement,
  d_neo.business_policy as neo_business_policy,
  d_neo.request as neo_request,
  d_neo.workdriver as neo_workdriver,
  d_neo.resolution_detail as neo_resolution_detail,  
  pse.atlas.best_partner_tier as partner_tier,
  pse.d_pro_service_tier as pro_service_tier,
  time.closed_day as closed_day,   
  attributes.closing_channel as closing_channel,
  counter as case_ct,
  pse.d_survey_satisfaction as satisfaction,
  survey.pse.ytdp_overall as Need_compared_satisfaction,
  pse.d_surveyed_counter as survey_ct,
  pse.d_satisfied_counter as psat_ct,
  metrics.count_for_turn_around as count_for_turn_around,
  metrics.emails_responded_in_sla as sla_met_email,
  metrics.emails_responded_in_sla_excluding_pst_weekends as sla_met_email_ex,
  pse.chat_in_sla_counter as sla_met_chat,
 survey.pse.rate_your_agreement as rate_your_agreement,
  survey.pse.rate_your_agreement_on_policies as rate_your_agreement_on_policies,
  survey.pse.ytdp_neither as ytdp_neither,
  survey.pse.ytdp_dissatisfied_else as ytdp_dissatisfied_else,
  survey.pse.ytdp_dissatisfied as ytdp_dissatisfied,
  survey.pse.ytdp_issue_resolved as ytdp_issue_resolved,
  pse.d_troubled_user.last_voice_of_user as troubled_user_last_voice_of_user,
 attributes.chat.chat_form_chat_type as chat_form_chat_type, 
  CASE WHEN metrics.count_for_consult >=1 THEN 1 ELSE 0 END as consult10,
  state.last_known_state_id as last_known_state_id,
  metrics.total_seconds_to_resolution as total_seconds_to_resolution,
  metrics.total_seconds_to_resolution_excluding_assignee_weekends as total_seconds_to_resolution_excluding_assignee_weekends,
  user.d_device_type as device_type,
  d_qplus.qa_pass_counter as qa_pass_counter,
  d_qplus.qa_score as qa_score,
  d_qplus.primary_dsat_driver as primary_dsat_driver,  
  internal.form_ytc_geolocation as form_ytc_geolocation,
  internal.form_auto_detected_os as form_auto_detected_os,
  attributes.pool as pool,
  attributes.d_spam_type as d_spam_type,
  attributes.d_validity as d_validity,
  internal.d_is_test_and_training as d_is_test_and_training,
  state.d_closed_counter as closed_counter,
  state.reopened as reopened,
  state.reopened_from_solution_offered as reopened_from_solution_offered,
  attributes.auth_attempt_count as auth_attempt_count,
  attributes.duplicate_source_count as duplicate_source_count,
  attributes.finished_as_duplicate as finished_as_duplicate,
  attributes.survey_channel as survey_channel,
  attributes.source as source,
  CASE WHEN attributes.survey_sent = TRUE THEN 1 ELSE 0 END as survey_sent,
  attributes.survey_footer_sent as survey_footer_sent,
  attributes.survey_form_id as survey_form_id,
  attributes.form_form as form_form,
  attributes.source_case_relationship as source_case_relationship,
  Case when pse.d_is_valid_partner_trt = TRUE and metrics.d_total_seconds_to_resolution > 0 Then 'Agent Handled Cases'
  When pse.d_is_valid_partner_trt = TRUE and metrics.d_total_seconds_to_resolution = 0 
  Then 'Machine Handled Cases' Else 'Invalid Cases' End as case_interaction_type,
  attributes.d_bug_id as bug_id, 
  d_case_link

from yt_iit_analyst.ops.support.mv_cases
WHERE (d_neo.locale like '%Korean%' or d_neo.locale like '%Japanese%')
AND pse.d_is_pse_case is TRUE
AND attributes.d_is_valid_contact is TRUE ) A 

LEFT JOIN chrisswan.pgm_objectives_data B 
on A.case_id=B.case_id

WHERE A.date >='2020-01-01'
AND A.satisfaction<=7
ORDER by 2 desc
